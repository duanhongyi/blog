---
title: 某些特殊机型下使用OkHttp导致Timeout的问题
tags: []
date: 2015-03-26 08:47:05
---

近几天发现某些Android特殊机型（vivo y17t）下的OkHttp经常报Timeout，而在其他机型下却没有这个问题，问题内容如下：

<div class="highlight"><pre><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InterruptedIOException</span><span class="o">:</span> <span class="n">timeout</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">AsyncTimeout</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">AsyncTimeout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">249</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">AsyncTimeout$2</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">AsyncTimeout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">217</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">RealBufferedSource</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">RealBufferedSource</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">300</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">RealBufferedSource</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">RealBufferedSource</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">289</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">RealBufferedSource</span><span class="o">.</span><span class="na">readUtf8LineStrict</span><span class="o">(</span><span class="n">RealBufferedSource</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">196</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpConnection</span><span class="o">.</span><span class="na">readHeaders</span><span class="o">(</span><span class="n">HttpConnection</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">219</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpConnection</span><span class="o">.</span><span class="na">readResponse</span><span class="o">(</span><span class="n">HttpConnection</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">198</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpTransport</span><span class="o">.</span><span class="na">readResponseHeaders</span><span class="o">(</span><span class="n">HttpTransport</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">80</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine</span><span class="o">.</span><span class="na">readNetworkResponse</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">830</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine</span><span class="o">.</span><span class="na">access$200</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">95</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine$NetworkInterceptorChain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">823</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine</span><span class="o">.</span><span class="na">readResponse</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">684</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">getResponse</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">272</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call$ApplicationInterceptorChain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">228</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">getResponseWithInterceptorChain</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">199</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">79</span><span class="o">)</span>
</pre></div>

或者是这个错误:

<div class="highlight"><pre><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">SocketTimeoutException</span>
        <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">PlainSocketImpl</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">PlainSocketImpl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">495</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">PlainSocketImpl</span><span class="o">.</span><span class="na">access$000</span><span class="o">(</span><span class="n">PlainSocketImpl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">46</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">PlainSocketImpl$PlainSocketInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">PlainSocketImpl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">240</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">Okio$2</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">Okio</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">137</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">AsyncTimeout$2</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">AsyncTimeout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">211</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">RealBufferedSource</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">RealBufferedSource</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">300</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">RealBufferedSource</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">RealBufferedSource</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">289</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">okio</span><span class="o">.</span><span class="na">RealBufferedSource</span><span class="o">.</span><span class="na">readUtf8LineStrict</span><span class="o">(</span><span class="n">RealBufferedSource</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">196</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpConnection</span><span class="o">.</span><span class="na">readResponse</span><span class="o">(</span><span class="n">HttpConnection</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">190</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpTransport</span><span class="o">.</span><span class="na">readResponseHeaders</span><span class="o">(</span><span class="n">HttpTransport</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">80</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine</span><span class="o">.</span><span class="na">readNetworkResponse</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">830</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine</span><span class="o">.</span><span class="na">access$200</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">95</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine$NetworkInterceptorChain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">823</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpEngine</span><span class="o">.</span><span class="na">readResponse</span><span class="o">(</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">684</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">getResponse</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">272</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call$ApplicationInterceptorChain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">228</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">getResponseWithInterceptorChain</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">199</span><span class="o">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">Call</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">79</span><span class="o">)</span>
</pre></div>

对应生成OkHttpClient的代码如下：

<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpClientFactory</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">MAX_IDLE_CONNECTIONS</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">KEEP_ALIVE_DURATION_MS</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="n">OkHttpClient</span> <span class="n">current</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">OkHttpClient</span> <span class="nf">_newHttpClient</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">();</span>
        <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">setNetwork</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="k">new</span> <span class="n">Network</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">DNSQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachedDNSQuery</span><span class="o">();</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">InetAddress</span><span class="o">[]</span> <span class="nf">resolveInetAddresses</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UnknownHostException</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">client</span><span class="o">.</span><span class="na">setConnectionPool</span><span class="o">(</span><span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">ConnectionPool</span><span class="o">(</span>
                <span class="n">MAX_IDLE_CONNECTIONS</span><span class="o">,</span> <span class="n">KEEP_ALIVE_DURATION_MS</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">OkHttpClient</span> <span class="nf">currentHttpClient</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">_newHttpClient</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">current</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

后经过测试发现在一些机型下 volatile static变量修饰OkHttpClient会导致OkHttp的流Timeout，将生成OkHttpClient的代码修改为：

<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpClientFactory</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">MAX_IDLE_CONNECTIONS</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">KEEP_ALIVE_DURATION_MS</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">OkHttpClient</span> <span class="n">client</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">HttpClientFactory</span> <span class="n">instance</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">HttpClientFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">();</span>
        <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">setNetwork</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="k">new</span> <span class="n">Network</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">DNSQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachedDNSQuery</span><span class="o">();</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">InetAddress</span><span class="o">[]</span> <span class="nf">resolveInetAddresses</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UnknownHostException</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">client</span><span class="o">.</span><span class="na">setConnectionPool</span><span class="o">(</span><span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">squareup</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">ConnectionPool</span><span class="o">(</span>
                <span class="n">MAX_IDLE_CONNECTIONS</span><span class="o">,</span> <span class="n">KEEP_ALIVE_DURATION_MS</span><span class="o">));</span>
        <span class="n">client</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="n">client</span><span class="o">.</span><span class="na">setWriteTimeout</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="n">client</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">OkHttpClient</span> <span class="nf">currentHttpClient</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpClientFactory</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="na">client</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

问题解决，具体原因可能涉及到的Android的Dalvik虚拟机的底层实现问题，有时间深纠一下。

后记：

是在某些机型下，强制类型转换会产生问题，属于jit优化的一个bug，使用android:vmSafeMode=&quot;true&quot;可以解决问题；或者使用最新的okhttp客户端。